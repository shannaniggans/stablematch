// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL") // e.g. file:./dev.db
}

// =========================
// Core Multi-Tenant Models
// =========================
model Practice {
  id        String        @id @default(cuid())
  name      String
  timezone  String        @default("Australia/Sydney")
  users     User[]
  services  Service[]
  clients   Client[]
  appts     Appointment[]
  invoices  Invoice[]
  audits    AuditLog[]
  waivers   WaiverRequest[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model User {
  // NextAuth base fields
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?

  // App fields
  passwordHash String?
  role       String   @default("practitioner")
  practiceId String
  practice   Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  accounts      Account[]
  sessions      Session[]
  notesAuthored Note[]         @relation("NoteAuthor")
  appointments  Appointment[]  @relation("ApptPractitioner")
  Availability  Availability[]
  AuditLog      AuditLog[]
  clientProfile Client?
  clientShareAccess ClientPractitionerShare[] @relation("PractitionerShares")
  clientsCreated Client[] @relation("ClientCreatedBy")
  linkRequests   ClientLinkRequest[] @relation("ClientLinkRequestPractitioner")
  travelSlots    PractitionerTravelSlot[]
  waiverRequests WaiverRequest[]

  @@index([practiceId])
}

model Client {
  id         String   @id @default(cuid())
  practiceId String
  practice   Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  firstName String
  lastName  String
  email     String?
  phone     String?
  address   String?
  notes     String?
  userId    String?  @unique
  user      User?    @relation(fields: [userId], references: [id])
  shareProfileWithPractitioners Boolean @default(false)
  shareHorsesWithPractitioners  Boolean @default(false)
  shareContactInfoDefault       Boolean @default(true)
  shareAddressDefault           Boolean @default(false)
  shareNotesDefault             Boolean @default(false)
  createdByPractitionerId       String?
  createdByPractitioner         User?    @relation("ClientCreatedBy", fields: [createdByPractitionerId], references: [id])
  isPrivate                     Boolean @default(false)
  privateUntilLinked            Boolean @default(false)

  horses   Horse[]
  appts    Appointment[]
  invoices Invoice[]
  shares   ClientPractitionerShare[] @relation("ClientShares")
  linkRequests ClientLinkRequest[]   @relation("ClientLinkRequests")
  waiverRequests WaiverRequest[]
  saddles Saddle[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([practiceId])
}

model Horse {
  id       String @id @default(cuid())
  clientId String
  client   Client @relation(fields: [clientId], references: [id], onDelete: Cascade)

  name              String
  breed             String?
  age               Int?
  dateOfBirth       DateTime?
  typeOfRiding      String?
  educationLevel    String?
  behaviouralNotes  String?
  lastDentalDate    DateTime?
  lastVaccinationDate DateTime?
  lastSaddleFitDate DateTime?
  lastWormingDate   DateTime?
  propertyName      String?
  propertyAddress   String?
  picNumber         String?
  photoDataUrl      String?
  color             String?
  height            String?
  sex               String?
  notes             String?

  appts Appointment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
}

model Service {
  id         String   @id @default(cuid())
  practiceId String
  practice   Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  name         String
  durationMins Int
  priceCents   Int
  taxRate      Float   @default(0.1)
  isActive     Boolean @default(true)

  appts Appointment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([practiceId])
}

model Availability {
  id             String @id @default(cuid())
  practitionerId String
  practitioner   User   @relation(fields: [practitionerId], references: [id], onDelete: Cascade)

  // 0 = Sunday ... 6 = Saturday
  weekday   Int
  // "HH:mm" (24h) local to practice timezone; store as text
  startTime String
  endTime   String

  effectiveFrom DateTime?
  effectiveTo   DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([practitionerId, weekday])
}

model Appointment {
  id         String   @id @default(cuid())
  practiceId String
  practice   Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  practitionerId String
  practitioner   User   @relation("ApptPractitioner", fields: [practitionerId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  horseId String?
  horse   Horse?  @relation(fields: [horseId], references: [id])

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])

  // Store as DateTime (Prisma serialises to ISO8601; fine for SQLite)
  start DateTime
  end   DateTime

  status       String  @default("scheduled")
  locationText String?

  notes Note[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([practiceId])
  @@index([practitionerId, start])
}

model Note {
  id            String      @id @default(cuid())
  appointmentId String
  appointment   Appointment @relation(fields: [appointmentId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation("NoteAuthor", fields: [authorId], references: [id])

  body      String
  isPrivate Boolean  @default(true)
  createdAt DateTime @default(now())
}

model ClientPractitionerShare {
  id              String   @id @default(cuid())
  clientId        String
  practitionerId  String
  shareProfile    Boolean  @default(true)
  shareHorses     Boolean  @default(true)
  shareContactInfo Boolean @default(true)
  shareAddress    Boolean  @default(false)
  shareNotes      Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  client        Client @relation("ClientShares", fields: [clientId], references: [id], onDelete: Cascade)
  practitioner  User   @relation("PractitionerShares", fields: [practitionerId], references: [id], onDelete: Cascade)

  @@unique([clientId, practitionerId])
  @@index([practitionerId])
}

model ClientLinkRequest {
  id          String   @id @default(cuid())
  clientId    String
  practitionerId String
  email       String?
  phone       String?
  status      String   @default("pending") // pending | approved | denied
  requestedAt DateTime @default(now())
  respondedAt DateTime?

  client       Client @relation("ClientLinkRequests", fields: [clientId], references: [id], onDelete: Cascade)
  practitioner User   @relation("ClientLinkRequestPractitioner", fields: [practitionerId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([practitionerId])
}

model PractitionerTravelSlot {
  id             String   @id @default(cuid())
  practitionerId String
  practitioner   User     @relation(fields: [practitionerId], references: [id], onDelete: Cascade)
  title          String
  description    String?
  locationName   String
  latitude       Float?
  longitude      Float?
  start          DateTime
  end            DateTime
  isRecurring    Boolean  @default(false)
  weekday        Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([practitionerId, start])
}

model WaiverRequest {
  id              String   @id @default(cuid())
  practiceId      String
  practice        Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)
  practitionerId  String
  practitioner    User     @relation(fields: [practitionerId], references: [id], onDelete: Cascade)
  clientId        String
  client          Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)
  title           String
  body            String
  status          String   @default("pending") // pending | signed | declined
  token           String   @unique
  sentAt          DateTime @default(now())
  signedAt        DateTime?
  signatureName   String?
  signatureEmail  String?
  signatureData   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([practiceId])
  @@index([clientId])
}

model Saddle {
  id        String   @id @default(cuid())
  clientId  String
  client    Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  type        String
  color       String?
  brand       String?
  seatSize    String?
  gulletWidth String?
  notes       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([clientId])
}

model Invoice {
  id         String   @id @default(cuid())
  practiceId String
  practice   Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  number   String @unique
  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  issuedAt DateTime
  dueAt    DateTime
  status   String   @default("draft")

  subtotalCents Int
  taxCents      Int
  totalCents    Int

  items     InvoiceItem[]
  payments  Payment[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@index([practiceId])
  @@index([clientId])
}

model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  description    String
  qty            Int
  unitPriceCents Int
  taxRate        Float    @default(0.1)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model Payment {
  id        String  @id @default(cuid())
  invoiceId String
  invoice   Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  amountCents           Int
  method                String // e.g. "cash" | "card" | "bank" | "stripe"
  paidAt                DateTime
  stripePaymentIntentId String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([invoiceId])
}

// =========================
// Audit
// =========================
model AuditLog {
  id         String   @id @default(cuid())
  practiceId String
  practice   Practice @relation(fields: [practiceId], references: [id], onDelete: Cascade)

  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  entityType String
  entityId   String
  action     String // "create" | "update" | "delete"
  diffJSON   String?
  createdAt  DateTime @default(now())

  @@index([practiceId, createdAt])
}

// =========================
// NextAuth Adapter Models
// (Standard from @next-auth/prisma-adapter)
// =========================
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
